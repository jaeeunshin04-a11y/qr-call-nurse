<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê°„í˜¸ì‚¬ í˜¸ì¶œ ëª¨ë‹ˆí„°ë§</title>
<style>
body { font-family: 'ë‚˜ëˆ”ê³ ë”•', sans-serif; background:#f0f4ff; text-align:center; padding:30px;}
h2{color:#2b4eff;margin-bottom:20px;}
table{margin:0 auto;border-collapse:collapse;width:90%;max-width:1000px;background:white;border-radius:15px;overflow:hidden;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
th,td{border-bottom:1px solid #eee;padding:12px;font-size:16px;}
th{background:#eaf0ff;color:#333;}
.red{background:#ffcccc;}
.yellow{background:#fff4cc;}
.white{background:white;}
.green{background:#ccffcc;}
button{padding:6px 10px;border:none;border-radius:10px;background:#2b4eff;color:white;cursor:pointer;transition:0.2s;}
button:hover{background:#1f36cc;}
</style>
</head>
<body>
<h2>ğŸ©º ê°„í˜¸ì‚¬ í˜¸ì¶œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</h2>
<p>ìƒˆ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>

<table id="requestTable">
<thead>
<tr>
<th>ë“±ë¡ë²ˆí˜¸</th><th>í™˜ìëª…</th><th>ë³‘ì‹¤</th><th>ìš”ì²­í•­ëª©</th>
<th>í•˜ìœ„í•­ëª©</th><th>ìš”ì²­ì‹œê°„</th><th>í™•ì¸ì‹œê°„</th>
<th>ì™„ë£Œì‹œê°„</th><th>í™•ì¸</th><th>ì™„ë£Œ</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const sheetURL = "https://script.google.com/macros/s/AKfycbw1b5ucdbPwLSW6JKz8rH5rttNDqdOfF5lSxwUJb5Gz5kMEuVXY9cv4ueKnvR3MYFpb/exec";

// ìš”ì²­ ìƒ‰ìƒ ê²°ì •
function getColor(type, detail){
  if(detail && detail.includes("ê¸°ê³„ ì•ŒëŒ")) return "red";
  if(type.includes("í†µì¦")||type.includes("ì•½")||type.includes("í™”ì¥ì‹¤")) return "red";
  if(type.includes("ìˆ˜ì•¡")||type.includes("ì¹¨êµ¬")||type.includes("ì‹œíŠ¸")) return "yellow";
  if(type.includes("ë¬¼")) return "white";
  return "white";
}

function formatTime(str){
  if(!str) return "";
  const d = new Date(str);
  return d.toLocaleTimeString('ko-KR', {hour12:false});
}

async function markConfirm(btn,row){
  const now = new Date();
  const nowText = formatTime(now);
  const tr = btn.closest("tr");
  tr.querySelector(".confirmTime").innerText = nowText;
  btn.innerText = "í™•ì¸ë¨";
  btn.disabled = true;

  await fetch(sheetURL,{
    method:"POST",
    body:JSON.stringify({action:"confirm", row:row})
  });
}

async function markDone(btn,row){
  const tr = btn.closest("tr");
  tr.classList.add("green");
  const now = new Date();
  const nowText = formatTime(now);
  tr.querySelector(".doneTime").innerText = nowText;
  btn.innerText = "ì™„ë£Œë¨";
  btn.disabled = true;

  await fetch(sheetURL,{
    method:"POST",
    body:JSON.stringify({action:"complete", row:row})
  });

  setTimeout(()=>{ tr.remove(); }, 3000);
}

function renderTable(data){
  const tbody = document.querySelector("#requestTable tbody");
  tbody.innerHTML = "";

  const shownRows = {}; // ê°™ì€ patientId+type+etc ì¤‘ë³µ ë°©ì§€

  data.forEach(row=>{
    const key = row.patientId+"_"+row.requestType+"_"+row.etc;
    if(shownRows[key]) return;
    shownRows[key] = true;

    const tr = document.createElement("tr");
    tr.classList.add(getColor(row.requestType,row.etc));

    tr.innerHTML = `
      <td>${row.patientId}</td>
      <td>${row.patientName}</td>
      <td>${row.room}</td>
      <td>${row.requestType}</td>
      <td>${row.etc}</td>
      <td>${formatTime(row.time)}</td>
      <td class="confirmTime">${formatTime(row.confirmTime)}</td>
      <td class="doneTime">${formatTime(row.completeTime)}</td>
      <td>
        <button onclick="markConfirm(this,${row.row})" ${row.confirmTime ? "disabled" : ""}>
          ${row.confirmTime ? "í™•ì¸ë¨" : "í™•ì¸"}
        </button>
      </td>
      <td>
        <button onclick="markDone(this,${row.row})" ${row.completeTime ? "disabled" : ""}>
          ${row.completeTime ? "ì™„ë£Œë¨" : "ì™„ë£Œ"}
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadRequests(){
  const res = await fetch(sheetURL+"?mode=getData");
  const data = await res.json();
  renderTable(data);
}

setInterval(loadRequests,2000);
loadRequests();
</script>
</body>
</html>
